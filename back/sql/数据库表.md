# 一、数据库表

## 建表语句(Sqlite)

```mysql
-- 如果表存在则先删除
DROP TABLE IF EXISTS Game;
DROP TABLE IF EXISTS TestDetail;
DROP TABLE IF EXISTS Dq;
DROP TABLE IF EXISTS QuizInfo;
DROP TABLE IF EXISTS Child;
DROP TABLE IF EXISTS Teacher_Class;
DROP TABLE IF EXISTS Teacher;
DROP TABLE IF EXISTS Class;
DROP TABLE IF EXISTS Parent;
DROP TABLE IF EXISTS Admin;


-- 管理员表
CREATE TABLE Admin (
  admin_id INTEGER PRIMARY KEY AUTOINCREMENT,
  pwd TEXT NOT NULL,
  phone TEXT NOT NULL UNIQUE,
  token TEXT
);

-- 家长表
CREATE TABLE Parent (
  guardian_id INTEGER PRIMARY KEY AUTOINCREMENT,
  phone TEXT NOT NULL UNIQUE,
  pwd TEXT NOT NULL,
  token TEXT
);

-- 班级表
CREATE TABLE Class (
  class_id INTEGER PRIMARY KEY AUTOINCREMENT,
  class_name TEXT NOT NULL,
  grade TEXT NOT NULL CHECK (grade IN ('小班','中班','大班','体验班')),
  student_count INTEGER NOT NULL,
  notes TEXT,
  created_at TEXT NOT NULL
);

-- 教师表
CREATE TABLE Teacher (
  teacher_id INTEGER PRIMARY KEY AUTOINCREMENT,
  teacher_name TEXT NOT NULL,
  phone TEXT NOT NULL UNIQUE,
  pwd TEXT NOT NULL,
  created_time TEXT NOT NULL,
  role TEXT,
  token TEXT
);

-- 教师-班级关联表
CREATE TABLE Teacher_Class (
  teacher_id INTEGER,
  class_id INTEGER,
  is_headTeacher INTEGER NOT NULL CHECK (is_headTeacher IN (0,1)),
  PRIMARY KEY (teacher_id, class_id),
  FOREIGN KEY (teacher_id) REFERENCES Teacher(teacher_id),
  FOREIGN KEY (class_id) REFERENCES Class(class_id)
);

-- 学生表
CREATE TABLE Child (
  child_id INTEGER PRIMARY KEY AUTOINCREMENT,
  child_name TEXT NOT NULL,
  gender TEXT NOT NULL CHECK (gender IN ('男','女')),
  nation TEXT NOT NULL,
  birth_date TEXT NOT NULL,
  note TEXT,
  created_time TEXT NOT NULL,
  class_id INTEGER,
  guardian_id INTEGER,
  FOREIGN KEY (class_id) REFERENCES Class(class_id),
  FOREIGN KEY (guardian_id) REFERENCES Parent(guardian_id)
);

-- 测试题库表
CREATE TABLE QuizInfo (
  quiz_id INTEGER PRIMARY KEY AUTOINCREMENT,
  quiz_name TEXT NOT NULL,
  quiz_method TEXT NOT NULL,
  pass_need TEXT NOT NULL,
  sort INTEGER NOT NULL CHECK (sort IN (1,2,3,4,5)),
  month_age INTEGER NOT NULL
);

-- 发育商表
CREATE TABLE Dq (
  dq_id INTEGER PRIMARY KEY AUTOINCREMENT,
  month_age INTEGER NOT NULL,
  gross_motor_score REAL DEFAULT 0,
  fine_motor_score REAL DEFAULT 0,
  language_score REAL DEFAULT 0,
  adaptability_score REAL DEFAULT 0,
  social_score REAL DEFAULT 0,
  dq REAL DEFAULT 0,
  date TEXT NOT NULL,
  pdf_path TEXT DEFAULT '',
  teacher_id INTEGER,
  child_id INTEGER,
  FOREIGN KEY (teacher_id) REFERENCES Teacher(teacher_id),
  FOREIGN KEY (child_id) REFERENCES Child(child_id)
);

-- 测试详情表
CREATE TABLE TestDetail (
  dq_id INTEGER NOT NULL,
  quiz_id INTEGER NOT NULL,
  is_pass INTEGER DEFAULT 0,
  PRIMARY KEY (dq_id, quiz_id),
  FOREIGN KEY (dq_id) REFERENCES Dq(dq_id),
  FOREIGN KEY (quiz_id) REFERENCES QuizInfo(quiz_id)
);

-- 游戏库
CREATE TABLE Game (
    game_id INTEGER PRIMARY KEY AUTOINCREMENT,
    game_name TEXT NOT NULL,
    game_sort INTEGER NOT NULL CHECK (game_sort IN (1, 2, 3, 4, 5)),
    game_beginTime INTEGER NOT NULL,
    game_endTime INTEGER NOT NULL,
    game_bg TEXT DEFAULT '',
    game_prepare TEXT NOT NULL,
    game_purpose TEXT NOT NULL,
    game_process TEXT NOT NULL,
    cautions TEXT NOT NULL
);
```





## 建表语句(MySQL)

```mysql
-- 如果表存在则先删除
DROP TABLE IF EXISTS TestDetail;
DROP TABLE IF EXISTS Dq;
DROP TABLE IF EXISTS QuizInfo;
DROP TABLE IF EXISTS Child;
DROP TABLE IF EXISTS Teacher_Class;
DROP TABLE IF EXISTS Teacher;
DROP TABLE IF EXISTS Class;
DROP TABLE IF EXISTS Parent;
DROP TABLE IF EXISTS Admin;
DROP TABLE IF EXISTS Game;

-- 管理员表
CREATE TABLE Admin (
  admin_id 		INT 			PRIMARY KEY AUTO_INCREMENT,
  pwd 			VARCHAR(255) 	NOT NULL,
  phone 		VARCHAR(20) 	NOT NULL UNIQUE,
  token 		VARCHAR(512)
);

-- 家长表
CREATE TABLE Parent (
  guardian_id 		INT 							PRIMARY KEY AUTO_INCREMENT,
  phone 			VARCHAR(20) 					NOT NULL UNIQUE,
  pwd 				VARCHAR(255) 					NOT NULL,
  token 		VARCHAR(512)
);

-- 班级表
CREATE TABLE Class (
  class_id 			INT 								PRIMARY KEY AUTO_INCREMENT,
  class_name 		VARCHAR(50) 						NOT NULL,
  grade 			ENUM('小班','中班','大班','体验班') 	  NOT NULL,
  student_count 	INT 								NOT NULL,
  notes 			TEXT										,
  created_at 		DATETIME 							NOT NULL
);

-- 教师表
CREATE TABLE Teacher (
  teacher_id 			INT 			PRIMARY KEY AUTO_INCREMENT,
  teacher_name 			VARCHAR(50) 	NOT NULL,
  phone 				VARCHAR(20) 	NOT NULL UNIQUE,
  pwd 					VARCHAR(255) 	NOT NULL,
  created_time 			DATETIME 		NOT NULL,
  role                  VARCHAR(20),
  token 		VARCHAR(512)
);

-- 教师-班级关联表
CREATE TABLE Teacher_Class (
  teacher_id      	INT,
  class_id        	INT,
  is_headTeacher 	TINYINT(1) 		NOT NULL CHECK (is_headTeacher IN (0,1)),
  PRIMARY KEY (teacher_id, class_id),
  FOREIGN KEY (teacher_id) REFERENCES Teacher(teacher_id),
  FOREIGN KEY (class_id) REFERENCES Class(class_id)
);

-- 学生表
CREATE TABLE Child (
  child_id 				INT 				PRIMARY KEY AUTO_INCREMENT,
  child_name 			VARCHAR(50) 		NOT NULL,
  gender 				ENUM('男','女') 	   NOT NULL,
  nation 				VARCHAR(20) 		NOT NULL,
  birth_date 			DATETIME 			NOT NULL,
  note 					TEXT,
  created_time 			DATETIME 			NOT NULL,
  class_id 				INT,
  guardian_id 			INT,
  FOREIGN KEY (class_id) REFERENCES Class(class_id),
  FOREIGN KEY (guardian_id) REFERENCES Parent(guardian_id)
);

-- 测试题库表
CREATE TABLE QuizInfo (
  quiz_id 		INT 			PRIMARY KEY AUTO_INCREMENT,
  quiz_name 	VARCHAR(100) 	NOT NULL,
  quiz_method 	VARCHAR(255) 	NOT NULL,
  pass_need 	VARCHAR(255) 	NOT NULL,
  sort 			TINYINT 		NOT NULL CHECK (sort IN (1,2,3,4,5)),
  month_age 	INT 			NOT NULL
);

-- 发育商表
CREATE TABLE Dq (
  dq_id 				INT 			PRIMARY KEY AUTO_INCREMENT,
  month_age 			INT 			NOT NULL,
  gross_motor_score 	FLOAT 			DEFAULT 0,
  fine_motor_score 		FLOAT 			DEFAULT 0,
  language_score 		FLOAT 			DEFAULT 0,
  adaptability_score 	FLOAT 			DEFAULT 0,
  social_score 			FLOAT 			DEFAULT 0,
  dq 					FLOAT 			DEFAULT 0,
  date 					DATETIME 		NOT NULL,
  pdf_path 				VARCHAR(255) 	DEFAULT '',
  teacher_id 			INT,
  child_id 				INT,
  FOREIGN KEY (teacher_id) REFERENCES Teacher(teacher_id),
  FOREIGN KEY (child_id) REFERENCES Child(child_id)
);

-- 测试详情表
CREATE TABLE TestDetail (
  dq_id 		INT 			NOT NULL,
  quiz_id 		INT 			NOT NULL,
  is_pass 		TINYINT(1) 		DEFAULT 0,
  PRIMARY KEY (dq_id, quiz_id),
  FOREIGN KEY (dq_id) REFERENCES Dq(dq_id),
  FOREIGN KEY (quiz_id) REFERENCES QuizInfo(quiz_id)
);

-- 游戏表
CREATE TABLE Game (
    game_id INT AUTO_INCREMENT PRIMARY KEY,
    game_name VARCHAR(255) NOT NULL,
    game_sort INT NOT NULL CHECK (game_sort IN (1, 2, 3, 4, 5)),
    game_beginTime INT NOT NULL,
    game_endTime INT NOT NULL,
    game_bg VARCHAR(255) DEFAULT '',
    game_prepare TEXT NOT NULL,
    game_purpose TEXT NOT NULL,
    game_process TEXT NOT NULL,
    cautions TEXT NOT NULL
);
```





## 伪造数据

```mysql
-- 以下伪造数据中含有密码的表都调用teacher端的add接口来添加，否则密码会直接以明文写入数据库，同时解密的时候会报错
-- 没有的密码的表可以直接用sql语句插

-- 插入管理员数据
INSERT INTO Admin (pwd, phone) VALUES ('admin123', '13800000000');

-- 插入家长数据
INSERT INTO Parent (phone, pwd) VALUES
('13800000001', 'parent123'),
('13800000002', 'parent123'),
('13800000003', 'parent123'),
('13800000004', 'parent123'),
('13800000005', 'parent123'),
('13800000006', 'parent123'),
('13800000007', 'parent123'),
('13800000008', 'parent123'),
('13800000009', 'parent123'),
('13800000010', 'parent123'),
('13800000011', 'parent123'),
('13800000012', 'parent123'),
('13800000013', 'parent123'),
('13800000014', 'parent123'),
('13800000015', 'parent123'),
('13800000016', 'parent123'),
('13800000017', 'parent123'),
('13800000018', 'parent123'),
('13800000019', 'parent123'),
('13800000020', 'parent123'),
('13800000021', 'parent123'),
('13800000022', 'parent123'),
('13800000023', 'parent123'),
('13800000024', 'parent123'),
('13800000025', 'parent123'),
('13800000026', 'parent123'),
('13800000027', 'parent123'),
('13800000028', 'parent123'),
('13800000029', 'parent123'),
('13800000030', 'parent123');


-- 插入班级数据
INSERT INTO Class (class_name, grade, student_count, notes, created_at) VALUES
('体验班', '体验班', 0, '非幼儿园学生，仅供体验测试功能', datetime('now')),
('小一班', '小班', 0, '小班学生', datetime('now')),
('中一班', '中班', 0, '中班学生', datetime('now')),
('大一班', '大班', 0, '大班学生', datetime('now'));


-- 插入教师数据
INSERT INTO Teacher (teacher_name, phone, pwd, created_time, role) VALUES
('刘园长', '13900000000', 'teacher123', datetime('now'), "园长"),
('张老师', '13900000001', 'teacher123', datetime('now'), ""),
('李老师', '13900000002', 'teacher123', datetime('now'), ""),
('王老师', '13900000003', 'teacher123', datetime('now'), ""),
('赵老师', '13900000004', 'teacher123', datetime('now'), ""),
('刘老师', '13900000005', 'teacher123', datetime('now'), ""),
('陈老师', '13900000006', 'teacher123', datetime('now'), "");


-- 插入教师-班级关联数据
INSERT INTO Teacher_Class (teacher_id, class_id, is_headTeacher) VALUES
(1, 2, 1),  -- 张老师是小一班班主任
(2, 2, 0),  -- 李老师是小一班普通老师
(3, 3, 1),  -- 王老师是中一班班主任
(4, 3, 0),  -- 赵老师是中一班普通老师
(5, 4, 1),  -- 刘老师是大一班班主任
(6, 4, 0);  -- 陈老师是大一班普通老师


-- 插入学生数据
INSERT INTO Child (child_name, gender, nation, birth_date, note, created_time, class_id, guardian_id) VALUES
-- 小一班学生 (1-10)
('张小明', '男', '汉族', '2025-06-01', '活泼好动', datetime('now'), 2, 1),
('李小红', '女', '汉族', '2025-05-01', '安静乖巧', datetime('now'), 2, 2),
('王小华', '男', '汉族', '2025-04-01', '喜欢画画', datetime('now'), 2, 3),
('赵小丽', '女', '汉族', '2025-03-01', '爱唱歌', datetime('now'), 2, 4),
('刘小强', '男', '汉族', '2025-02-01', '运动能力强', datetime('now'), 2, 5),
('陈小美', '女', '汉族', '2025-01-01', '喜欢跳舞', datetime('now'), 2, 6),
('杨小刚', '男', '汉族', '2024-12-01', '爱搭积木', datetime('now'), 2, 7),
('周小芳', '女', '汉族', '2024-11-01', '爱看书', datetime('now'), 2, 8),
('吴小勇', '男', '汉族', '2024-10-01', '喜欢恐龙', datetime('now'), 2, 9),
('郑小燕', '女', '汉族', '2024-09-01', '爱交朋友', datetime('now'), 2, 10),
-- 中一班学生 (11-20)
('孙小杰', '男', '汉族', '2024-08-01', '喜欢科学', datetime('now'), 3, 11),
('朱小婷', '女', '汉族', '2024-07-01', '爱讲故事', datetime('now'), 3, 12),
('胡小军', '男', '汉族', '2024-06-01', '运动健将', datetime('now'), 3, 13),
('林小玉', '女', '汉族', '2024-05-01', '喜欢跳舞', datetime('now'), 3, 14),
('梁小波', '男', '汉族', '2024-04-01', '爱搭积木', datetime('now'), 3, 15),
('黄小梅', '女', '汉族', '2024-03-01', '安静乖巧', datetime('now'), 3, 16),
('谢小东', '男', '汉族', '2024-02-01', '喜欢恐龙', datetime('now'), 3, 17),
('徐小兰', '女', '汉族', '2024-01-01', '爱画画', datetime('now'), 3, 18),
('高小勇', '男', '汉族', '2023-12-01', '活泼好动', datetime('now'), 3, 19),
('马小丽', '女', '汉族', '2023-11-01', '爱唱歌', datetime('now'), 3, 20),
-- 大一班学生 (21-30)
('罗小强', '男', '汉族', '2023-05-01', '运动能力强', datetime('now'), 4, 21),
('韩小美', '女', '汉族', '2022-12-01', '喜欢跳舞', datetime('now'), 4, 22),
('唐小刚', '男', '汉族', '2022-06-01', '爱搭积木', datetime('now'), 4, 23),
('冯小芳', '女', '汉族', '2021-12-01', '爱看书', datetime('now'), 4, 24),
('董小勇', '男', '汉族', '2021-06-01', '喜欢恐龙', datetime('now'), 4, 25),
('萧小燕', '女', '汉族', '2020-12-01', '爱交朋友', datetime('now'), 4, 26),
('程小杰', '男', '汉族', '2020-06-01', '喜欢科学', datetime('now'), 4, 27),
('曹小婷', '女', '汉族', '2019-12-01', '爱讲故事', datetime('now'), 4, 28),
('袁小军', '男', '汉族', '2019-06-01', '运动健将', datetime('now'), 4, 29),
('邓小玉', '女', '汉族', '2018-12-01', '喜欢跳舞', datetime('now'), 4, 30);


-- 插入测试题目数据 -> 执行 insert_quizInfo.py，数据见quizInfo.xlsx

-- 插入游戏库数据   -> 执行 insert_game.py，数据见game.xlsx
```







## 表设计

### 1  管理员表结构设计：`Admin`

| 字段名     | 类型   | 约束       | 说明                      |
| ---------- | ------ | ---------- | ------------------------- |
| `admin_id` | INT    | 主键，自增 | 管理员唯一标识            |
| `pwd`      | STRING | 非空       | 加密后的密码（如 bcrypt） |
| `phone`    | STRING | 非空，唯一 | 手机号                    |



### 2  家长表结构设计：`Parent`

| 字段名        | 类型   | 约束       | 说明                             |
| ------------- | ------ | ---------- | -------------------------------- |
| `guardian_id` | INT    | 主键，自增 | 家长账户唯一 ID                  |
| `phone`       | STRING | 非空，唯一 | 家长手机号（用于登录与绑定验证） |
| `pwd`         | STRING | 非空       | 登录密码（加密）                 |



### 3  班级表结构设计：`Class`

| 字段名          | 类型     | 约束                                    | 说明                                                         |
| --------------- | -------- | --------------------------------------- | ------------------------------------------------------------ |
| `class_id`      | INT      | 主键，自增                              | 班级唯一 ID                                                  |
| `class_name`    | STRING   | 非空                                    | 班级名称，如“中班A”                                          |
| `grade`         | STRING   | check('小班', '中班', '大班', '体验班') | 年级/阶段，“小班”、“中班”、“大班”、“体验班”，确保体验班的 class_id=1 |
| `student_count` | INT      | 非空                                    | 班级学生人数                                                 |
| `notes`         | TEXT     |                                         | 备注                                                         |
| `created_at`    | datetime | 非空                                    | 创建时间                                                     |



### 4  教师表结构设计：`Teacher`

| 字段名         | 类型     | 约束       | 说明                                   |
| -------------- | -------- | ---------- | -------------------------------------- |
| `teacher_id`   | INT      | 主键，自增 | 教师唯一标识符（UUID 或系统自动生成）  |
| `teacher_name` | STRING   | 非空       | 老师姓名                               |
| `phone`        | STRING   | 非空，唯一 | 登录账号（可为手机号或工号）           |
| `pwd`          | STRING   | 非空       | 加密存储的登录密码                     |
| `created_time` | datetime | 非空       | 注册时间                               |
| `role`         | STRING   |            | 特殊角色，目前有：“园长”，“管理级教师” |



### 5  教师-班级关联表结构设计：`Teacher_Class`

| 字段名           | 类型 | 约束        | 说明           |
| ---------------- | ---- | ----------- | -------------- |
| `teacher_id`     | INT  | 主键，外键  | 教师唯一标识符 |
| `class_id`       | INT  | 主键，外键  | 班级唯一标识符 |
| `is_headTeacher` | INT  | check(0, 1) | 是否为班主任   |



### 6  学生表结构设计：`Child`

| 字段名         | 类型     | 约束              | 说明                                       |
| -------------- | -------- | ----------------- | ------------------------------------------ |
| `child_id`     | INT      | 主键，自增        | 系统生成的唯一标识符（UUID 或自动递增 ID） |
| `child_name`   | STRING   | 非空              | 儿童姓名                                   |
| `gender`       | STRING   | check('男', '女') | 男 / 女                                    |
| `nation`       | STRING   | 非空              | 民族                                       |
| `birth_date`   | datetime | 非空              | 出生日期（用于计算当前月龄）               |
| `class_id`     | INT      | 外键              | 所在班级 ID                                |
| guardian_id    | INT      | 外键              | 监护人ID                                   |
| `note`         | TEXT     |                   | 备注信息                                   |
| `created_time` | datetime | 非空              | 注册时间                                   |



### 7  测试题库表：`QuizInfo`

| 字段名        | 类型   | 约束             | 说明                                                         |
| ------------- | ------ | ---------------- | ------------------------------------------------------------ |
| `quiz_id`     | INT    | 主键，自增       | 测试题的 ID                                                  |
| `quiz_name`   | STRING | 非空             | 测查项目                                                     |
| `quiz_method` | STRING | 非空             | 操作方法                                                     |
| `pass_need`   | STRING | 非空             | 测查通过要求                                                 |
| `sort`        | INT    | check(1,2,3,4,5) | 项目类型，1：大 运 动；2：精细动作；3：语言；4：适应能力；5：社会行为 |
| `month_age`   | INT    | 非空             | 测试所需达到的月龄                                           |



### 8  发育商表结构设计：`Dq`

| 字段名               | 类型     | 约束       | 说明                                 |
| -------------------- | -------- | ---------- | ------------------------------------ |
| `dq_id`              | INT      | 主键，自增 | 本次测评唯一 ID                      |
| `teacher_id`         | INT      | 外键       | 执行测评老师 ID                      |
| `child_id`           | INT      | 外键       | 被测儿童 ID（关联 `ChildInfo`）      |
| `month_age`          | INT      | 非空       | 进行测评时的月龄（如 36）            |
| `gross_motor_score`  | FLOAT    | default=0  | 大运动原始分                         |
| `fine_motor_score`   | FLOAT    | default=0  | 精细动作原始分                       |
| `language_score`     | FLOAT    | default=0  | 语言原始分                           |
| `adaptability_score` | FLOAT    | default=0  | 适应能力原始分                       |
| `social_score`       | FLOAT    | default=0  | 社会行为原始分                       |
| `dq`                 | FLOAT    | default=0  | 综合发育商（Developmental Quotient） |
| `date`               | datetime | 非空       | 测评日期                             |
| `pdf_path`           | STRING   | default='' | PDF 报告路径（如生成后存储）         |



### 9  测试详情 ：`TestDetail`

| 字段名    | 类型 | 约束             | 说明         |
| --------- | ---- | ---------------- | ------------ |
| `dq_id`   | INT  | 非空，主键，外键 | 关联发育商表 |
| `quiz_id` | INT  | 非空，主键，外键 | 测试题目     |
| `is_pass` | INT  | default=0        | 是否通过     |



### 10  游戏库 ：`Game`

| 字段名           | 类型   | 约束             | 说明         |
| ---------------- | ------ | ---------------- | ------------ |
| `game_id`        | INT    | 主键，自增       |              |
| `game_name`      | STRING | 非空             | 游戏名称     |
| `game_sort`      | INT    | check(1,2,3,4,5) | 发展领域     |
| `game_beginTime` | INT    | 非空             | 适应月龄开始 |
| `game_endTime`   | INT    | 非空             | 适应月龄结束 |
| `game_bg`        | STRING | default=''       | 游戏背景     |
| `game_prepare`   | STRING | 非空             | 游戏准备     |
| `game_purpose`   | STRING | 非空             | 游戏目的     |
| `game_process`   | STRING | 非空             | 游戏过程     |
| `cautions`       | STRING | 非空             | 注意事项     |





# 二、触发器

```mysql
-- 当新增学生时增加班级人数
CREATE TRIGGER update_class_count_insert
AFTER INSERT ON Child
FOR EACH ROW
WHEN NEW.class_id IS NOT NULL
BEGIN
    UPDATE Class 
    SET student_count = student_count + 1 
    WHERE class_id = NEW.class_id;
END;

-- 当学生班级变更时更新新旧班级人数
CREATE TRIGGER update_class_count_update
AFTER UPDATE OF class_id ON Child
FOR EACH ROW
WHEN NEW.class_id IS NOT NULL OR OLD.class_id IS NOT NULL
BEGIN
    -- 减少旧班级人数
    UPDATE Class 
    SET student_count = student_count - 1 
    WHERE class_id = OLD.class_id AND student_count > 0;
    
    -- 增加新班级人数
    UPDATE Class 
    SET student_count = student_count + 1 
    WHERE class_id = NEW.class_id;
END;

-- 当删除学生时减少班级人数
CREATE TRIGGER update_class_count_delete
AFTER DELETE ON Child
FOR EACH ROW
WHEN OLD.class_id IS NOT NULL
BEGIN
    UPDATE Class 
    SET student_count = student_count - 1 
    WHERE class_id = OLD.class_id AND student_count > 0;
END;


-- 确保每个班级只有一个班主任（更新）
CREATE TRIGGER ensure_single_head_teacher_update
BEFORE UPDATE OF is_headTeacher ON Teacher_Class
FOR EACH ROW
WHEN NEW.is_headTeacher = 1
BEGIN
    -- 检查是否已有班主任
    SELECT CASE
        WHEN EXISTS (
            SELECT 1
            FROM Teacher_Class
            WHERE class_id = NEW.class_id
            AND is_headTeacher = 1
            AND teacher_id != NEW.teacher_id
        )
        THEN RAISE(ABORT, '每个班级只能有一个班主任')
    END;
END;

-- 确保每个班级只有一个班主任（插入）
CREATE TRIGGER ensure_single_head_teacher_insert
BEFORE INSERT ON Teacher_Class
FOR EACH ROW
WHEN NEW.is_headTeacher = 1
BEGIN
    -- 检查是否已有班主任
    SELECT CASE
        WHEN EXISTS (
            SELECT 1
            FROM Teacher_Class
            WHERE class_id = NEW.class_id
            AND is_headTeacher = 1
        )
        THEN RAISE(ABORT, '每个班级只能有一个班主任')
    END;
END;
```

